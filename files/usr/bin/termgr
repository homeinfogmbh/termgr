#! /usr/bin/env python3
"""Command line tool to manage HOMEINFO terminals

  (C) 2015-2016:  HOMEINFO - Digitale Informationssysteme GmbH

  Maintainer:     Richard Neumann <r.neumann@homeinfo.de>


Usage:
    termgr update <expr> [options]
    termgr stage <expr> [options]
    termgr upgrade <package> <expr> [options]
    termgr system-upgrade <expr> [options]
    termgr (reboot | chkres | unlock) <expr> [options]
    termgr fixpkg <expr> <pkgs>...

Options:
    -h --help       Show this screen.
    --version       Show version.
    --verbose       Be gassy.
    --undeployed    Also handle undeployed terminals.
    --user=<user>   Specify user account for SSH connections.
"""

from os import geteuid
from sys import stderr
from getpass import getuser
from os.path import basename

from homeinfo.lib.log import Logger, LogLevel, TTYAnimation
from homeinfo.lib.system import Parallelization

from homeinfo.terminals.filter import TerminalFilter
from homeinfo.terminals.orm import Terminal

from termgr.ctrl import TerminalsController
from termgr.lib.filter import deployed


VERBOSE = False
TERMGR_USER = 'termgr'


if __name__ == '__main__':
    from docopt import docopt

    options = docopt(__doc__)
    logger = Logger(basename(__file__), level=LogLevel.INFO)

    if geteuid() == 0:
        print('Refusing to run as root')
        exit(3)
    elif getuser() != TERMGR_USER:
        print('You must be {0} to run {1}'.format(
            TERMGR_USER, __file__), file=stderr)
        exit(2)
    else:
        USER = options['--user'] if options['--user'] else TERMGR_USER
        VERBOSE = options['--verbose']

        # Get terminals generator
        if not options['<expr>']:
            terminals = Terminal.select().where(
                ~(Terminal.deployed >> None) &
                (Terminal.testing == 0))
        else:
            terminals = TerminalFilter(options['<expr>'])

        # Filter out undeployed terminals
        if not options['--undeployed']:
            terminals = (t for t in terminals if t.deployed)

        ctrl = TerminalsController()

        # Perform selected operation
        if options['update']:
            template = 'Updating {message}: {animation}'

            with Parallelization(ctrl.update, terminals, single=True) as para:
                with TTYAnimation(para, template=template):
                    para.wait()

            for failure in para.failures:
                print(failure)
        elif options['stage']:
            template = 'Staging {message}: {animation}'

            with Parallelization(ctrl.stage, terminals, single=True) as para:
                with TTYAnimation(para, template=template):
                    para.wait()
        elif options['system-upgrade']:
            template = 'Upgrading {message}: {animation}'

            with Parallelization(ctrl.upgrade, terminals, single=True) as para:
                with TTYAnimation(para, template=template):
                    para.wait()
        elif options['reboot']:
            template = 'Rebooting {message}: {animation}'

            with Parallelization(ctrl.reboot, terminals, single=True) as para:
                with TTYAnimation(para, template=template):
                    para.wait()
        elif options['unlock']:
            template = 'Unlocking {message}: {animation}'

            with Parallelization(ctrl.unlock, terminals, single=True) as para:
                with TTYAnimation(para, template=template):
                    para.wait()
        elif options['chkres']:
            template = 'Checking resolution {message}: {animation}'

            with Parallelization(ctrl.chkres, terminals, single=True) as para:
                with TTYAnimation(para, template=template):
                    para.wait()
        elif options['fixpkg']:
            packages = options['<pkgs>'] or PackageManagerCommand.BASE_PKGS
            install = ctrl.install(*pkgs, asexplicit=True)
            template = 'Fixing packages {message}: {animation}'

            with Parallelization(install, terminals, single=True) as para:
                with TTYAnimation(para, template=template):
                    para.wait()
