#! /usr/bin/env python3
"""OpenVPN configuration package client."""

from argparse import ArgumentParser
from getpass import getpass
from logging import DEBUG, INFO, basicConfig, getLogger
from pathlib import Path
from sys import exit, stdout    # pylint: disable=W0622

from requests import session


LOGGER = getLogger('sysvpn')
LOG_FORMAT = '[%(levelname)s] %(name)s: %(message)s'
HIS_LOGIN_URL = 'https://his.homeinfo.de/session'
TERMGR_VPN_URL = 'https://termgr.homeinfo.de/setup/openvpn'
TERMGR_FINALIZE_URL = 'https://termgr.homeinfo.de/setup/finalize'


def get_args():
    """Parses the command line arguments."""

    parser = ArgumentParser(description='OpenVPN configuration retrieval.')
    parser.add_argument('system', type=int, help='the system ID')
    parser.add_argument('-d', '--debug', action='store_true',
                        help='enable debug mode')
    parser.add_argument('-f', '--file', type=Path, help='output file')
    parser.add_argument('-m', '--model', help='Set model')
    parser.add_argument('-o', '--operating-system', help='Set OS')
    parser.add_argument('-p', '--pubkey', help='Set WireGuard pubkey')
    parser.add_argument('-s', '--serial-number', help='Set serial number')
    parser.add_argument('-u', '--user', help='HIS user name')
    parser.add_argument('-w', '--windows', action='store_true',
                        help='package for MS Windows systems')
    return parser.parse_args()


def retrieve_data(login_data, args):
    """Retrieves OpenVPN data for the respective system."""

    with session() as sess:
        response = sess.post(HIS_LOGIN_URL, json=login_data)

        if response.status_code != 200:
            LOGGER.error('Error during login.')
            LOGGER.debug(response.content)
            exit(2)

        vpn_data = {'system': args.system, 'windows': args.windows}
        response = sess.post(TERMGR_VPN_URL, json=vpn_data)

        if response.status_code != 200:
            LOGGER.error('Error during VPN data retrieval.')
            LOGGER.debug(response.content)
            exit(3)

        if args.path:
            with args.path.open('wb') as file:
                file.write(response.content)
        else:
            stdout.buffer.write(response.content)

        finalize_data = {
            'sn': args.serial_number,
            'os': args.operating_system,
            'model': args.model,
            'wg_pubkey': args.pubkey
        }
        response = sess.post(TERMGR_FINALIZE_URL, json=finalize_data)

        if response.status_code != 200:
            LOGGER.error('Error during finalizing.')
            LOGGER.debug(response.content)
            exit(4)


def main():
    """Main script."""

    args = get_args()
    basicConfig(format=LOG_FORMAT, level=DEBUG if args.debug else INFO)

    if args.user:
        user = args.user
    else:
        try:
            user = input('User name: ')
        except (EOFError, KeyboardInterrupt):
            print()
            LOGGER.error('Aborted by user.')
            exit(1)

    try:
        passwd = getpass('Password: ')
    except (EOFError, KeyboardInterrupt):
        print()
        LOGGER.error('Aborted by user.')
        exit(1)

    login_data = {'account': user, 'passwd': passwd}
    retrieve_data(login_data, args)


if __name__ == '__main__':
    main()
